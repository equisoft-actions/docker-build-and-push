name: Multi-Architecture Docker Build

on:
  workflow_call:
    inputs:
      registry:
        description: The registry where the image will be pushed to
        type: string
        required: false
        default: registry.equisoft.io
      aws-region:
        description: AWS region for the registry
        type: string
        required: false
      build-args:
        description: Arguments passed to the build command
        type: string
        required: false
        default: ""
      context:
        description: Relative path under $GITHUB_WORKSPACE for the Docker context
        type: string
        required: false
        default: "."
      dockerfile:
        description: Relative Dockerfile under working-directory
        type: string
        required: false
        default: Dockerfile
      name:
        description: A simple name for this image
        type: string
        required: true
      no-cache:
        description: Do not use cache when building the image
        type: boolean
        required: false
        default: false
      is-release:
        description: If this build is a production release
        type: boolean
        required: false
        default: false
      pull:
        description: Always attempt to pull all referenced images
        type: boolean
        required: false
        default: false
      push:
        description: Push the built image
        type: boolean
        required: true
        default: false
      role-to-assume:
        description: Role to assume that has write access to the registry
        type: string
        required: false
      role-session-name:
        description: Session name to use when assuming the role
        type: string
        required: false
      version:
        description: The SemVer compatible version for this image
        type: string
        required: true
      working-directory:
        description: Relative path under $GITHUB_WORKSPACE where the project is located
        type: string
        required: false
        default: "."

    outputs:
      image-version:
        description: Image version built by this workflow
        value: ${{ jobs.build.outputs.image-version }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.metadata.outputs.tags }}
      labels: ${{ steps.metadata.outputs.labels }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare image data
        id: metadata
        uses: equisoft-actions/docker-metadata@v1
        with:
          title: ${{ inputs.name }}
          image-name: ${{ inputs.registry }}/${{ inputs.name }}
          release: ${{ inputs.is-release }}
          version: ${{ inputs.version }}

  build:
    # self-hosted dynamic label (cloud or self-hosted) true/false
    # Define instance sizes (medium, large, xlarge, 2xlarge) to make it work cloud or self-hosted

    #2-core (large)
    #8 GB RAM · 75 GB SSD

    #4-core (xlarge)
    #16 GB RAM · 150 GB SSD

    #8-core (2xlarge)
    #32 GB RAM · 300 GB SSD

    runs-on: [ self-hosted, "${{ matrix.platform}}" ]
    needs:
      - prepare
    strategy:
      fail-fast: true
      matrix:
        platform:
          - amd64
          - arm64
          ### Make it dynamic if needed, defaults on both architectures
    steps:
      - name: Build and push ${{ matrix.platform }}
        id: build
        uses: equisoft-actions/docker-build-and-push@DOPS-5820/retire-buildx
        with:
          registry: ${{ inputs.registry }}
          aws-region: ${{ inputs.aws-region }}
          build-args: ${{ inputs.build-args }}
          context: ${{ inputs.context }}
          dockerfile: ${{ inputs.dockerfile }}
          labels: ${{ needs.prepare.outputs.labels }}
          name: ${{ inputs.name }}
          no-cache: ${{ inputs.no-cache }}
          is-release: ${{ inputs.is-release }}
          platform: ${{ matrix.platform }}
          pull: ${{ inputs.pull }}
          push: ${{ inputs.push }}
          role-to-assume: ${{ inputs.role-to-assume }}
          role-session-name: ${{ inputs.role-session-name }}-${{ matrix.platform }}
          tags: ${{ needs.prepare.outputs.tags }}
          version: ${{ inputs.version }}
          working-directory: ${{ inputs.working-directory }}

  create-manifest:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build
    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Action context
        shell: bash
        id: context
        run: |
          echo "has-role=${{ inputs.role-to-assume != '' }}" >> $GITHUB_OUTPUT
          echo "is-ecr=${{ inputs.aws-region != '' }}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: steps.context.outputs.is-ecr == 'true'
        with:
          aws-access-key-id: ${{ steps.context.outputs.has-role != 'true' && inputs.aws-access-key-id || '' }}
          aws-secret-access-key: ${{ steps.context.outputs.has-role != 'true' && inputs.aws-secret-access-key || '' }}
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: ${{ inputs.role-to-assume }}
          role-session-name: ${{ inputs.role-session-name }}-manifest

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
        if: steps.context.outputs.is-ecr == 'true'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create and Push Manifests
        working-directory: ${{ runner.temp }}/digests
        env:
          TAGS: ${{ needs.prepare.outputs.tags }}
        run: |
          images=$(for f in digest-*; do echo "${{ inputs.registry }}/${{ inputs.name }}@$(cat $f)"; done)
          echo "Source images for manifest: $images"

          tag_args=()
          IFS=',' read -ra tag_array <<< "$TAGS"
          for tag in "${tag_array[@]}"; do
            if [[ -n "$tag" ]]; then
              tag_args+=("-t" "$tag")
            fi
          done
          echo "Tags to apply: ${tag_args[@]}"

          docker buildx imagetools create "${tag_args[@]}" $images

          for tag in "${tag_array[@]}"; do
            if [[ -n "$tag" ]]; then
              echo "Pushing $tag"
              docker manifest push "$tag"
            fi
          done
